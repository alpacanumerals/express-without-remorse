<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Express Without Remorse</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

  <script>
  const navMenu = (scene) => {
    const style = { fontSize: '16px', fill: '#FFF' }
    const station = scene.add.text(50, 100, 'Station', style)
    station.setInteractive();
    station.on('pointerup', function () {
      scene.scene.start('StationScene')
    })
    const bar = scene.add.text(50, 120, 'Dive Bar', style)
    bar.setInteractive();
    bar.on('pointerup', function () {
      scene.scene.start('BarScene')
    })
    const junkyard = scene.add.text(50, 140, 'Junkyard', style)
    junkyard.setInteractive();
    junkyard.on('pointerup', function () {
      scene.scene.start('JunkScene')
    })
    const platform = scene.add.text(50, 160, 'Platform', style)
    platform.setInteractive();
    platform.on('pointerup', function () {
      scene.scene.start('TrainScene')
    })
  }

  const StationScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function StationScene ()
    {
      Phaser.Scene.call(this, { key: 'StationScene' });
    },

    preload: function ()
    {
      this.load.image('platform', 'assets/platform.png');
      this.load.image('map1', 'assets/smap1.png');
      this.load.image('map2', 'assets/smap2.png');
      this.load.image('map3', 'assets/smap3.png');
    },

    create: function ()
    {
      this.add.sprite(450, 360, 'platform');
      navMenu(this);
    }
  });

  const BarScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function BarScene ()
    {
      Phaser.Scene.call(this, { key: 'BarScene' });
    },

    preload: function ()
    {
      this.load.image('bar', 'assets/spacebar.png');
    },

    create: function ()
    {
      this.add.sprite(450, 360, 'bar');
      navMenu(this);
    }
  });

  const JunkScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function JunkScene ()
    {
      Phaser.Scene.call(this, { key: 'JunkScene' });
    },

    preload: function ()
    {
      this.load.image('junkyard', 'assets/junkyard.png');
    },

    create: function ()
    {
      this.add.sprite(450, 360, 'junkyard');
      navMenu(this);
    }
  });

  var cursors;
  var wasd;

  var bote;
  var hitbox;

  var turrets;
  var bullets;
  var lowerBoundSentry;

  var globalspeed = 100;

  const TrainScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function TrainScene () {
      Phaser.Scene.call(this, { key: 'TrainScene' });
    },

    preload: function () {
      this.load.image('bote', 'assets/bote.png');
      this.load.image('turret', 'assets/bote.png');
      this.load.image('bullet', 'assets/bullet1.png');
    },

    create: function () {
      navMenu(this);
      bote = this.physics.add.sprite(450, 360, 'bote');
      bote.setCollideWorldBounds(true);
      bote.setCircle(3, 11, 14);

      cursors = this.input.keyboard.createCursorKeys();
      wasd = this.input.keyboard.addKeys(
        {up:Phaser.Input.Keyboard.KeyCodes.W,
        down:Phaser.Input.Keyboard.KeyCodes.S,
        left:Phaser.Input.Keyboard.KeyCodes.A,
        right:Phaser.Input.Keyboard.KeyCodes.D}
      );

      turrets = this.physics.add.group({
        key: 'turret',
        repeat: 11,
        setXY: { x: 50, y: -720, stepY: 120 },
        collideWorldBounds: false,
      });

      const resetTurret = (sentry, turret) => {
        turret.setY(-720);
      };

      lowerBoundSentry = this.physics.add.sprite(50, 720, 'bote');
      lowerBoundSentry.setImmovable();
      this.physics.add.collider(turrets, lowerBoundSentry, resetTurret);
      bullets = this.physics.add.group({});
      // bullets = this.physics.add.group({
      //   key: 'bullet',
      //   repeat: 1000,
      //   setXY: {x: -100, y: -100},
      //   collideWorldBounds: false
      // });

      const hit = (bote, bullet) => {
        bullet.disableBody(true, true);
      };
      this.physics.add.collider(bote, bullets, hit);

      const time = new Date().getTime();

      const basicShot = (turret, time) => {
        const shoot = () => {
          const bullet = bullets.create(turret.x, turret.y, 'bullet');
          bullet.setVelocityY(globalspeed);
          bullet.setVelocityX(100);
          //bullet.setCircle(3, 11, 14);
        }
        if (time > turret.shotTimer) {
          shoot();
          turret.shotTimer = time + Phaser.Math.Between(0, 5000);
        }
      };
      turrets.children.iterate((turret) => turret.shotTimer = time + Phaser.Math.Between(0, 5000));
      turrets.children.iterate((turret) => turret.shootBehaviour = basicShot);
      // console.log(turrets.getChildren());
    },

    update: function () {

      const time = new Date().getTime();

      turrets.setVelocityY(globalspeed);

      turrets.children.iterate((turret) => turret.shootBehaviour(turret, time))

      if (cursors.left.isDown || wasd.left.isDown)
      {
        bote.setVelocityX(-200);
      }
      else if (cursors.right.isDown || wasd.right.isDown)
      {
        bote.setVelocityX(200);
      }
      else
      {
        bote.setVelocityX(0);
      }
      if (cursors.up.isDown || wasd.up.isDown)
      {
        bote.setVelocityY(-200);
      }
      else if (cursors.down.isDown || wasd.down.isDown)
      {
        bote.setVelocityY(200);
      }
      else
      {
        bote.setVelocityY(0);
      }
    }
  });

  var config = {
    type: Phaser.AUTO,
    width: 900,
    height: 720,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: { y: 0 },
        debug: true,
      }},
    scene: [StationScene, BarScene, JunkScene, TrainScene]
  };

  var game = new Phaser.Game(config);

  function preload() {}

  function create() {}

  function update() {}
  </script>

</body>
</html>
