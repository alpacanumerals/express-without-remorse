<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Express Without Remorse</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

  <script>
  const navMenu = (scene) => {
    const style = { fontSize: '16px', fill: '#FFF' }
    const station = scene.add.text(50, 100, 'Station', style)
    station.setInteractive();
    station.on('pointerup', function () {
      scene.scene.start('StationScene');
    })
    const bar = scene.add.text(50, 120, 'Dive Bar', style)
    bar.setInteractive();
    bar.on('pointerup', function () {
      scene.scene.start('BarScene');
    })
    const junkyard = scene.add.text(50, 140, 'Junkyard', style)
    junkyard.setInteractive();
    junkyard.on('pointerup', function () {
      scene.scene.start('JunkScene');
    })
    const platform = scene.add.text(50, 160, 'Platform', style)
    platform.setInteractive();
    platform.on('pointerup', function () {
      scene.scene.start('TrainScene');
    })
  }

  const StationScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function StationScene ()
    {
      Phaser.Scene.call(this, { key: 'StationScene' });
    },

    preload: function ()
    {
      this.load.image('platform', 'assets/platform.png');
      this.load.image('map1', 'assets/smap1.png');
      this.load.image('map2', 'assets/smap2.png');
      this.load.image('map3', 'assets/smap3.png');
    },

    create: function ()
    {
      this.add.sprite(450, 360, 'platform');
      navMenu(this);
    }
  });

  var maxGlobalSpeed = 200;
  var maxHp = 0;
  var tacticalSpeed = 200;
  var diagonalSpeed = Math.sqrt((tacticalSpeed**2)/2);

  const BarScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function BarScene ()
    {
      Phaser.Scene.call(this, { key: 'BarScene' });
    },

    preload: function ()
    {
      this.load.image('bar', 'assets/spacebar.png');
    },

    create: function ()
    {
      this.add.sprite(450, 360, 'bar');
      navMenu(this);
    }
  });

  var junkCount = 5;
  var creditCount = 0;

  const junkConvo1 = [
    "Riding junk off the New Resurrection Loop?",
    "Watch you don't get yourself killed.",
  ]
  var junkHeaderText;
  var junkText;
  var sellText;
  var quitText;
  var cashText;

  const upgradeConvo = [
    "Urgh Shogoth urk ftagn afk credeets!",
    "(Shogoth have wares if Rider have credits)",
  ]
  var upgradeHeaderText;
  var enginesText;
  var thrustersText;
  var shieldsText;
  var quitShopText;

  const JunkScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function JunkScene ()
    {
      Phaser.Scene.call(this, { key: 'JunkScene' });
    },

    preload: function ()
    {
      this.load.image('junkyard', 'assets/junkyard.png');
      this.load.image('junker', 'assets/ppl-junk-junker.png');
      this.load.image('upgrades', 'assets/ppl-junk-upgrades.png');
    },

    create: function ()
    {

      const updateMoney = (credits) => {
        creditCount += credits;
        cashText.setText('Credits: ' + creditCount);
      }
      const sellJunk = () => {
        updateMoney(junkCount*100);
        junkCount = 0;
        junkText.setText('Junk: ' + junkCount);
      }

      const quitJunkShop = () => {
        junkHeaderText.setText('');
        junkText.setText('');
        sellText.setText('');
        quitText.setText('');
      }
      const launchJunkShop = () => {
        junkHeaderText.setText(junkConvo1);
        junkText.setText('Junk: ' + junkCount);
        sellText.setText('SELL');
        quitText.setText('QUIT');
        sellText.on('pointerup', function (pointer) {
          sellJunk();
        });
        quitText.on('pointerup', function (pointer) {
          quitJunkShop();
        });
      }

      const buyEngine = () => {
        const price = 100;
        if (creditCount >= price){
          updateMoney(-price);
          maxGlobalSpeed += 50;
        }
      }
      const buyThruster = () => {
        const price = 100;
        if (creditCount >= price){
          updateMoney(-price);
          tacticalSpeed += 50;
        }
      }
      const buyShield = () => {
        const price = 200;
        if (creditCount >= price){
          updateMoney(-price);
          maxHp += 1;
        }
      }
      const quitUpgradeShop = () => {
        upgradeHeaderText.setText('');
        enginesText.setText('');
        thrustersText.setText('');
        shieldsText.setText('');
        quitShopText.setText('');
      }
      const launchUpgradeShop = () => {
        upgradeHeaderText.setText(upgradeConvo);
        enginesText.setText('Buy engines (+speed)').setInteractive();
        thrustersText.setText('Buy thrusters (+maneuver)').setInteractive();
        shieldsText.setText('Buy shields (+shields)').setInteractive();
        quitShopText.setText('QUIT').setInteractive();
        enginesText.on('pointerup', function (pointer) {
          buyEngine();
        });
        thrustersText.on('pointerup', function (pointer) {
          buyThruster();
        });
        shieldsText.on('pointerup', function (pointer) {
          buyShield();
        });
        quitShopText.on('pointerup', function (pointer) {
          quitUpgradeShop();
        });
      }

      this.add.sprite(450, 360, 'junkyard');
      junker = this.add.sprite(675, 275, 'junker').setInteractive();
      junker.on('pointerup', function (pointer) {
        quitUpgradeShop();
        launchJunkShop();
      });

      upgrades = this.add.sprite(250, 360, 'upgrades').setInteractive();
      upgrades.on('pointerup', function (pointer) {
        quitJunkShop();
        launchUpgradeShop();
      });


      junkHeaderText = this.add.text(300, 500, '');
      junkText = this.add.text(300, 550, '');
      sellText = this.add.text(300, 575, '').setInteractive();
      quitText = this.add.text(400, 575, '').setInteractive();

      upgradeHeaderText = this.add.text(300, 500, '');
      enginesText = this.add.text(300, 550, '').setInteractive();;
      thrustersText = this.add.text(300, 575, '').setInteractive();
      shieldsText = this.add.text(300, 600, '').setInteractive();
      quitShopText = this.add.text(300, 625, '').setInteractive();

      cashText = this.add.text(700, 75, 'Credits: ' + creditCount);

      navMenu(this);
    }
  });

  var cursors;
  var wasd;
  var throttle;
  var throttleUp;
  var throttleDown;

  const evaluateKeys = () => {
    if (wasd.left.isDown)
    {
      if (wasd.up.isDown)
      {
        bote.setVelocityX(-diagonalSpeed);
        bote.setVelocityY(-diagonalSpeed);
      }
      else if (wasd.down.isDown)
      {
        bote.setVelocityX(-diagonalSpeed);
        bote.setVelocityY(diagonalSpeed);
      }
      else
      {
        bote.setVelocityX(-tacticalSpeed);
        bote.setVelocityY(0);
      }
    }
    else if (wasd.right.isDown)
    {
      if (wasd.up.isDown)
      {
        bote.setVelocityX(diagonalSpeed);
        bote.setVelocityY(-diagonalSpeed);
      }
      else if (wasd.down.isDown)
      {
        bote.setVelocityX(diagonalSpeed);
        bote.setVelocityY(diagonalSpeed);
      }
      else
      {
        bote.setVelocityX(tacticalSpeed);
        bote.setVelocityY(0);
      }
    }
    else {
      if (wasd.up.isDown)
      {
        bote.setVelocityX(0);
        bote.setVelocityY(-tacticalSpeed);
      }
      else if (wasd.down.isDown)
      {
        bote.setVelocityX(0);
        bote.setVelocityY(tacticalSpeed);
      }
      else
      {
        bote.setVelocityX(0);
        bote.setVelocityY(0);
      }
    }
  }

  var bote;
  var hitbox;

  var turrets;
  var bullets;
  var lowerBoundSentry;

  var hp;
  var globalSpeed = 100;

  const updateGlobalSpeedBullets = () => {
    // later different behaviour for more complex bullets
    // an 'updateGlobalSpeed' method on bullets, initialised to null
    bullets.getChildren().forEach((bullet) => {
      if (bullet.active) {
        bullet.setVelocityY(globalSpeed);
      }
    })
  }
  const changeGlobalSpeed = (delta) => {
    const newGlobalSpeed = globalSpeed + delta;
    if (0 <= newGlobalSpeed && newGlobalSpeed <= maxGlobalSpeed) {
      globalSpeed = newGlobalSpeed;
      updateGlobalSpeedBullets();
      speedText.setText('speed: ' + globalSpeed + '/' + maxGlobalSpeed);
    }
  }

  var globalTime;
  const getGlobalTime = () => globalTime;

  var distance;
  var timeRemaining;

  var shieldText;
  var distanceText;
  var timeText;
  var speedText;

  var bulletIndex = 0;
  var bulletCollider;

  const disableBullet = (bullet) => {
    bullet.disableBody(true, false);
    bullet.body.reset(10, 10);
    bullet.setActive(false);
  };

  const updateDistance = (delta) => {
    distance -= delta;
    distanceText.setText('distance: ' + Math.ceil(distance));
  }

  const updateTimeRemaining = (delta) => {
    timeRemaining -= delta;
    timeText.setText('time limit: ' + Math.ceil(timeRemaining));
  }

  const TrainScene = new Phaser.Class({

    Extends: Phaser.Scene,

    initialize:

    function TrainScene () {
      Phaser.Scene.call(this, { key: 'TrainScene' });
    },

    preload: function () {
      this.load.image('bote', 'assets/bote.png');
      this.load.image('turret', 'assets/bote.png');
      this.load.image('bullet', 'assets/bullet1.png');
    },

    create: function () {
      distance = 50000;
      timeRemaining = 15;

      globalSpeed = 100;

      distanceText = this.add.text(700, 75, 'distance: ' + distance);
      timeText = this.add.text(700, 100, 'time limit: ' + timeRemaining);
      speedText = this.add.text(700, 125, 'speed: ' + globalSpeed + '/' + maxGlobalSpeed);

      const time = new Date().getTime();
      navMenu(this);

      // cursors = this.input.keyboard.createCursorKeys();
      wasd = this.input.keyboard.addKeys({
        up: Phaser.Input.Keyboard.KeyCodes.W,
        down: Phaser.Input.Keyboard.KeyCodes.S,
        left: Phaser.Input.Keyboard.KeyCodes.A,
        right: Phaser.Input.Keyboard.KeyCodes.D,
      });

      throttle = {
        up: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),
        down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN),
      };

      throttleUp = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
      throttleDown = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN);
      throttle.up.on('down', function (key, event) {
        changeGlobalSpeed(10);
      });
      throttle.down.on('down', function (key, event) {
        changeGlobalSpeed(-10);
      });

      bote = this.physics.add.sprite(450, 360, 'bote');
      bote.setCollideWorldBounds(true);
      bote.setCircle(3, 11, 14);
      bote.setImmovable();
      bote.invuln = false;
      bote.invulnExpire = 0;

      const hitBote = (ship) => {
        --hp;
        shieldText.setText('Shields: ' + hp);
        ship.activateStun();
      }

      const activateStun = () => {
        bote.setTint(0xff0000);
        bote.invuln = true;
        bote.invulnExpire = getGlobalTime() + 1000;
        this.physics.world.removeCollider(bulletCollider);
      }

      bote.activateStun = activateStun;

      hp = maxHp;

      shieldText = this.add.text(700, 50, 'shields: ' + hp);

      turrets = this.physics.add.group({
        key: 'turret',
        repeat: 11,
        setXY: { x: 50, y: -720, stepY: 120 },
        collideWorldBounds: false,
      });

      const resetTurret = (sentry, turret) => {
        turret.setY(-720);
      };

      lowerBoundSentry = this.physics.add.image(50, 720, 'bote');
      lowerBoundSentry.setImmovable();
      this.physics.add.collider(turrets, lowerBoundSentry, resetTurret);

      bullets = this.physics.add.group({
        key: 'bullet',
        repeat: 1000,
        setXY: {x: 10, y: 10},
        collideWorldBounds: false,
      });
      lowerBulletWall = this.physics.add.image(450, 920, 'bote');
      lowerBulletWall.setImmovable();
      lowerBulletWall.body.setSize(1100, 100, true);

      upperBulletWall = this.physics.add.image(450, -920, 'bote');
      upperBulletWall.setImmovable();
      upperBulletWall.body.setSize(1100, 100, true);

      leftBulletWall = this.physics.add.image(-200, 360, 'bote');
      leftBulletWall.setImmovable();
      leftBulletWall.body.setSize(100, 1640, true);

      rightBulletWall = this.physics.add.image(1200, 360, 'bote');
      rightBulletWall.setImmovable();
      rightBulletWall.body.setSize(100, 1640, true);

      const hitWall = (wall, bullet) => {
        disableBullet(bullet);
      }

      this.physics.add.collider(lowerBulletWall, bullets, hitWall);
      this.physics.add.collider(upperBulletWall, bullets, hitWall);
      this.physics.add.collider(leftBulletWall, bullets, hitWall);
      this.physics.add.collider(rightBulletWall, bullets, hitWall);

      const hit = (ship, bullet) => {
        disableBullet(bullet);
        hitBote(ship);
      };
      bulletCollider = this.physics.add.collider(bote, bullets, hit);

      const basicShot = (turret, time) => {
        const shoot = () => {
          const bullet = bullets.getChildren()[bulletIndex];
          bullet.body.reset(turret.x, turret.y);
          bullet.setActive(true);
          bullet.body.enable = true;
          bullet.setVelocityY(globalSpeed);
          bullet.setVelocityX(300);
          //bullet.setCircle(3, 11, 14);
          if (bulletIndex < bullets.getChildren().length-1) {
            ++bulletIndex;
          } else {
            bulletIndex = 0;
          }
        }
        if (time > turret.shotTimer) {
          shoot();
          turret.shotTimer = time + Phaser.Math.Between(500, 5000);
        }
      };
      turrets.children.iterate((turret) => turret.shotTimer = time + Phaser.Math.Between(0, 5000));
      turrets.children.iterate((turret) => turret.shootBehaviour = basicShot);
    },

    update: function (gameTime, delta) {

      //const time = new Date().getTime();
      globalTime = new Date().getTime();

      updateDistance(globalSpeed*delta/1000);
      updateTimeRemaining(delta/1000);

      turrets.setVelocityY(globalSpeed);

      turrets.children.iterate((turret) => turret.shootBehaviour(turret, globalTime))

      evaluateKeys();

      if (bote.invuln && bote.invulnExpire < globalTime) {
        bote.invuln = false;
        bote.clearTint();
        this.physics.world.colliders.add(bulletCollider);
      }

      if (hp < 0) {
        // lose condition
        this.scene.start('StationScene');
      }

      if (timeRemaining < 0) {
        // lose condition
        this.scene.start('StationScene');
      }

      if (distance < 0) {
        // win condition
        this.scene.start('StationScene');
      }
    }
  });

  var config = {
    type: Phaser.AUTO,
    width: 900,
    height: 720,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: { y: 0 },
        debug: false,
      }},
    scene: [StationScene, BarScene, JunkScene, TrainScene]
  };

  var game = new Phaser.Game(config);

  function preload() {}

  function create() {}

  function update() {}
  </script>

</body>
</html>
